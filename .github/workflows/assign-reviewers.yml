name: Assign Reviewers Automatically

on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  assign-reviewers:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Assign reviewers based on changed files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const reviewers = new Set();
            
            // Determine which packages were changed
            const changedPackages = new Set();
            
            files.forEach(file => {
              if (file.filename.startsWith('packages/frontend/')) {
                changedPackages.add('frontend');
              } else if (file.filename.startsWith('packages/backend/')) {
                changedPackages.add('backend');
              } else if (file.filename.startsWith('packages/shared/')) {
                changedPackages.add('shared');
              } else if (file.filename.startsWith('packages/docs/')) {
                changedPackages.add('docs');
              } else {
                // Root files affect all packages
                changedPackages.add('root');
              }
            });

            // Assign reviewers based on changed packages
            if (changedPackages.has('frontend') || changedPackages.has('root')) {
              reviewers.add('brakid'); // Replace with actual frontend team members
            }
            if (changedPackages.has('backend') || changedPackages.has('root')) {
              reviewers.add('brakid'); // Replace with actual backend team members
            }
            if (changedPackages.has('shared') || changedPackages.has('root')) {
              reviewers.add('brakid'); // Replace with actual core team members
            }
            if (changedPackages.has('docs') || changedPackages.has('root')) {
              reviewers.add('brakid'); // Replace with actual docs team members
            }

            // Request reviews
            if (reviewers.size > 0) {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                reviewers: Array.from(reviewers)
              });
              
              console.log(`Requested reviews from: ${Array.from(reviewers).join(', ')}`);
            } else {
              console.log('No specific reviewers assigned based on changed files.');
            }